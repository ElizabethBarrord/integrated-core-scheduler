<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>FYIC SCHEDULER</title>
  <link rel=stylesheet type=text/css href=../css/universal.css>
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
  <!--Import jQuery before materialize.js-->
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <!-- Compiled and minified JavaScript -->

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
  <script>
    ///////////////////////////////////////////
    //****** INITIALIZING VARIABLES ******/////
    ///////////////////////////////////////////
    // sections[key=section_name, value=section_times]
    var sections = new Map();
    // sections[key=room_name, value=room_times]
    var rooms = new Map();
    // professors[key=last_name, value=section_names]
    var professors = new Map();
    var possibilities = new Map();
    var assignments = new Map();
    var filePath = "";

    // array to push the sections that do have possibilities
    var section_no_poss = [];
    // array to push the sections that have professor conflicts
    var section_no_prof = [];

    //////////////////////////////////////
    //****** READ IN THE CSV *******/////
    ////////////////////////////////////
    $.ajax({
     url: 'input_data.csv',
     dataType: 'text',
    }).done(readCSV);

    function readCSV(data) {
     var allTextLines = data.split(/\r?\n|\n/);
     var headers = allTextLines[0].split(',');
     var lines = [];
     for (var i = 1; i < allTextLines.length; i++) {
      var data = allTextLines[i].split(',');
      if (data.length == headers.length) {
       var tarr = [];
       for (var j = 0; j < headers.length; j++) {
        tarr.push(headers[j] + ":" + data[j]);
       }
       lines.push(tarr);
      }
     }
     for (var a = 0; a < lines.length; a++) {
      // FORMAT OF ROW
      // Array(2)
      // 0 : "Section:AA_Mon830-950.Wed830-950"
      // 1 : "Room:0020_Mon830-950.Wed830-950"
      // length : 2
      var row = lines[a];
      // each row [] is a header
      var section_avail = row[0];
      var room_avail = row[1];
      var prof_avail = row[2];
      // parse section availability in row[0]
      var section = section_avail.substr(section_avail.indexOf(":") + 1, 2);
      var section_times = section_avail.substr(section_avail.indexOf("_") + 1, section_avail.length);
      var temp1 = [];
      temp1 = section_times.split('.');
      sections.set(section, temp1);
      // parse room availability in row[1]
      var room = room_avail.substr(room_avail.indexOf(":") + 1, 4);
      var room_times = room_avail.substr(room_avail.indexOf("_") + 1, room_avail.length);
      var temp2 = [];
      temp2 = room_times.split('.');
      rooms.set(room, temp2);
      // parse professor availability in row[2]
      var last_name = prof_avail.substr(prof_avail.indexOf(":") + 1, 4);
      var p_sections = prof_avail.substr(prof_avail.indexOf("_") + 1, prof_avail.length);
      var temp3 = [];
      temp3 = p_sections.split('.');
      professors.set(last_name, temp3);
     }
    }

    ////////////////////////////
    //****** MATCH *******/////
    ///////////////////////////
    // this method iterates through the sections and rooms
    // maps and find the matches in the times and pushes
    // the matches to a new map called possibilities
    function find_matches() {
     for (var section of sections.keys()) {
      var section_times = sections.get(section);
      var match = [];
      for (room of rooms.keys()) {
       var room_times = rooms.get(room);
       for (var i = 0; i < section_times.length; i++) {
        for (var j = 0; j < room_times.length; j++) {
         if (section_times[i] == room_times[j]) {
          match.push("ROOM" + [room] + "@" + room_times[j]);
         }
        }
       }
      }
      var match2 = [];
      $.each(match, function(i, el) {
       if ($.inArray(el, match2) === -1) match2.push(el);
      });
      possibilities.set(section, match2);
     }
    }

    //////////////////////////////////////////
    //****** LIST ROOMS FOR REFERENCE *****//
    ////////////////////////////////////////
    function list_rooms() {
     var room_nums = [];
     for (room of rooms.keys()) {
      room_nums.push(room);
     }
     var output = "<ul class=\"collection\">";
     for (r of room_nums) {
      output += "<li class=\"collection-item\">" + r + "</li>";
     }
     output += "</ul>";
     $("#room").append(output);
    }

    //////////////////////////////////////////
    //****** OUTPUT FOR POSSIBILITIES *****//
    ////////////////////////////////////////
    function generate_accordian() {
     var all_keys = [];
     for (section of possibilities.keys()) {
      all_keys.push(section);
     }
     var string_out = "";
     for (var i = 0; i < all_keys.length; i++) {
      var p = possibilities.get(all_keys[i]);
      string_out += "<button class=\"accordion\">" + all_keys[i] + "<i style='float:right'class='material-icons'>expand_more</i></button><div class=\"panel\"><p>" + p + "</p></div>";
     }
     var string_out2 = string_out.replace(/,/g, '<br>');
     $("#accord").append(string_out2);
     // $("#acc_pannel").append(string_out2);
    }

    function check_for_professor_availability() {
     var all_sections = [];
     for (section of assignments.keys()) {
      all_sections.push(section);
     }
     for (var i = 0; i < all_sections.length; i++) {
      var rt1 = assignments.get(all_sections[i]);
      if (rt1 == "no possibilities") {
       section_no_poss.push(all_sections[i]);
      }
      for (var j = 1; j < all_sections.length; j++) {
       var rt2 = assignments.get(all_sections[j]);
       if (rt1.substring(9, rt1.length) == rt2.substring(9, rt2.length)) {
        for (p of professors.keys()) {
         var p_section = professors.get(p);
         if ((p_section.includes(all_sections[i]) && p_section.includes(all_sections[j])) && (all_sections[i] != all_sections[j])) {
          section_no_prof.push(all_sections[i]);
          $('.collection li').each(function() {
           var item = $(this);
           var text = item.text();
           if (text.includes(rt1.substring(9, rt1.length))) {
            // assign();
            $(this).css({
             'color': 'blue'
            });
           }
          });
         }
        }
       }
      }
     }
    }

    ////////////////////////////////////////
    //****** ASSIGN POSSIBILITIES*****/////
    //////////////////////////////////////
    function assign() {
     // empty the arrays for no possibilities and professor conflicts
     // for when it is called again in the fix conflicts method.
     section_no_poss = [];
     section_no_prof = [];

     // console.log("assign clicked");
     $("#assignments").html('');
     var already_assigned = [];
     var i = 0;
     for (section of possibilities.keys()) {
      var p = possibilities.get(section);
      i = Math.floor(Math.random() * p.length);
      if (!already_assigned.includes(p[i])) {
       assignments.set(section, p[i]);
       already_assigned.push(p[i]);
      } else {
       assignments.set(section, "no possibilities");
      }
     }
     var output2 = "";
     var output3 = "<ul id=mmm class=\"collection\">";
     for (assignment of assignments.keys()) {
      var room_and_time = assignments.get(assignment);
      output2 = assignment + "=" + room_and_time + "<br/>";
      output3 += "<li class=\"collection-item\">" + output2 + "</li>";
     };
     output3 += "</ul>";
     $("#assignments").append(output3);

     $('.collection li').each(function() {
      var item = $(this);
      var text = item.text();
      if (text.includes("no possibilities")) {
       $(this).css({
        'color': 'red',
        'font-size': '150%'
       });
      }
     });
     check_for_professor_availability();
    }

    /////////////////////////////////
    //****** FIX CONFLICTS *******//
    ///////////////////////////////
    function fix_professors() {
     // if there are elements in the no possibilities array OR
     // if there are elements in the professor conflicts array
     if (section_no_poss.length > 0 || section_no_prof.length > 0) {
      // then call the assign function until the arrays are empty
      do {
       assign();
      } while (section_no_poss.length > 0 || section_no_prof.length > 0);
     }

    }


    /////////////////////////////////////////////////////
    //****** Convert data into proper 2D array *******//
    ///////////////////////////////////////////////////
    function download_CSV() {
     assign();
     fix_professors();
     //console.log(assignments);

     var newkeys = Array.from(assignments.keys());
     var newvalues = Array.from(assignments.values());
     console.log(newkeys);
     //console.log(newvalues);

     var newroom = []
     var newtime = []

     newvalues.forEach(name => {
      let splat = name.split('@')

      newroom.push(splat[0])
      newtime.push(splat[1])
     })

     console.log(newroom)
     console.log(newtime)

     console.log(zip(newkeys, newroom, newtime));

     var newresults = zip(newkeys, newroom, newtime);

     console.log(arrayToCSV(newresults));


    }


    /////////////////////////////////
    //****** zip N arrays *******///
    ///////////////////////////////

    function zip(a, b, c) {
     var arr = [];
     for (var key in a) arr.push([a[key], b[key], c[key]]);
     return arr;
    }


    ///////////////////////////////////////
    //****** Array to CSV format *******//
    /////////////////////////////////////

    function arrayToCSV(twoDiArray) {
     //  Modified from: http://stackoverflow.com/questions/17836273/
     //  export-javascript-data-to-csv-file-without-server-interaction
     var csvRows = [];
     for (var i = 0; i < twoDiArray.length; ++i) {
      for (var j = 0; j < twoDiArray[i].length; ++j) {
       twoDiArray[i][j] = '\"' + twoDiArray[i][j] + '\"'; // Handle elements that contain commas
      }
      csvRows.push(twoDiArray[i].join(','));
     }

     var csvString = csvRows.join('\r\n');
     var a = document.createElement('a');
     a.href = 'data:attachment/csv,' + csvString;
     a.target = '_blank';
     a.download = 'myFile.csv';

     document.body.appendChild(a);
     a.click();
     // Optional: Remove <a> from <body> after done
    }


    /////////////////////////
    //****** BEGIN *******//
    ///////////////////////
    window.onload = function() {
     list_rooms();
     find_matches();
     generate_accordian();
     // FOR THE RESULTS ACCORDIAN
     var acc = document.getElementsByClassName("accordion");
     for (var i = 0; i < acc.length; i++) {
      acc[i].addEventListener("click", function() {
       this.classList.toggle("active");
       var panel = this.nextElementSibling;
       if (panel.style.display === "block") {
        panel.style.display = "none";
       } else {
        panel.style.display = "block";
       }
      });
     }
    };
  </script>
</head>

<body>
  <nav>
    <div class="nav-wrapper">
      <a href="index.html" class="brand-logo">FYIC Scheduler</a>
    </div>
  </nav>
  <div class=container>
    <div class=row>
      <div class="col l4 m4 s6">
        <h4 class=center style="font-weight:normal;">Rooms</h4>
        <div class=center id=room></div>
      </div>
      <div class="col l4 m4 s6">
        <h4 class=center style="font-weight:normal;">Possibilities</h4>
        <div style="" class=center id=accord></div>
        <!-- <button class="accordion">Expand Possibilities<i style="float:right"class="material-icons">expand_more</i></button><div id=acc_pannel class="panel"><p></p></div> -->
      </div>
      <div class="col l4 m4 s6">
        <div class=center>
          <h4 style="font-weight:normal;">Assignment</h4>
          <p style="color:blue">There is a teacher scheduled in two rooms at the same time</p>
          <p style="color:red">There are no more rooms available for this section</p>
          <button id=ass class=center style="padding:10px;" type="button" onclick="assign()">Generate Assignments</button>
          <button class=center style="padding:10px;" type="button" onclick="fix_professors()">Fix Conflicts</button>
        <button onclick="download_CSV()">Download CSV</button>
        </div>
        <div class=center id=assignments></div>
      </div>
      <!-- <button class=center style="padding:10px;" type="button" onclick="fix_possitbilities()">Fix Possibilties</button> -->

      </row>
    </div>
</body>

</html>
